/*
 * ad9102.c
 *
 *  Created on: 30 Sep 2022
 *      Author: Martijn Roubos
 */

#include "ad9102.h"

/*** SPI register addresses ***/
uint16_t reg_add[62]=		        {0x0000, 0x0001, 0x0002, 0x0003, 0x0004, 0x0005, 0x0006, 0x0007, 0x0008, 0x0009, 0x000a, 0x000b, 0x000c, 0x000d, 0x000e, 0x001f, 0x0020, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027, 0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f, 0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0036, 0x0037, 0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0047, 0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057, 0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f};
uint16_t AD9102_example6_regval[62]={0x0000, 0x0e00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1f00, 0x0000, 0x0000, 0x0000, 0x000E, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1232, 0x0111, 0xffff, 0x0000, 0x0101, 0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7E00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0002, 0x0000, 0x0000, 0x0fa0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7FFF};

uint16_t AD9102_example4_regval[66]={0x0000, 0x0e00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1f00, 0x0000, 0x0000, 0x0000, 0x000E, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3212, 0x0121, 0xffff, 0x0000, 0x0101, 0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0606, 0x1999, 0x9a00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0fa0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x16FF, 0x0001, 0x0001};

uint16_t AD9102_example1_regval[66]={0x0000, 0x0e00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1f00, 0x0000, 0x0000, 0x0000, 0x000E, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3030, 0x0111, 0xffff, 0x0000, 0x0101, 0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0200, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0fa0, 0x0000, 0xfff0, 0x0100, 0x0001, 0x0001};
uint16_t AD9102_example2_regval[66]={0x0000, 0x0e00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1f00, 0x0000, 0x0000, 0x0000, 0x000E, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3030, 0x0111, 0xffff, 0x0000, 0x0101, 0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0200, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0fa0, 0x0000, 0x3ff0, 0x0100, 0x0001, 0x0001};
uint16_t AD9102_example3_regval[66]={0x0000, 0x0e00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1f00, 0x0000, 0x0000, 0x0000, 0x000E, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3232, 0x0111, 0xffff, 0x0000, 0x0101, 0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0200, 0x0a3d, 0x7100, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0fa0, 0x0000, 0x0000, 0x0100, 0x0001, 0x0001};

uint16_t AD9102_example5_regval[66]={0x0000, 0x0e00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1f00, 0x0000, 0x0000, 0x0000, 0x000E, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3333, 0x0111, 0xffff, 0x0000, 0x0101, 0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000, 0x0000, 0x0200, 0x0750, 0x7500, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0fa0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xfff0, 0x0100, 0x0001, 0x0001};


/*********************************************************/
// SPI FUNCTIONS
/*********************************************************/
/*
 * @brief Write 16-bit data to AD910x SPI/SRAM register
 * @param addr - SPI/SRAM address
 * @param data - data to be written to register address
 * @return none
 */
void spi_write( uint16_t addr, int16_t data )
{
	uint8_t bytes[4] =
	{
	  (addr >> 8) & 0xFF,  // shift by 0 not needed, of course, just stylistic
	  (addr >> 0) & 0xFF,
	  (data >> 8) & 0xFF,  // shift by 0 not needed, of course, just stylistic
	  (data >> 0) & 0xFF,
	};

	DRIVER_MASTER_SPI.Send(bytes, 4);

    wait_us( 1 );
}

/*
 * @brief Read 16-bit data from AD910x SPI/SRAM register
 * @param addr - SPI/SRAM address
 * @return reg_data - data returned by AD910x
 */

int16_t spi_read( uint16_t addr )
{
    int csb = 0;

    int16_t reg_data;

    uint16_t read_addr = 0x8000+addr;
    reg_data = DRIVER_MASTER_SPI.Receive( read_addr, 2 );

    csb = 1;
    wait_us( 1 );

    return reg_data;
}


void update_regs()
{

    for ( int i=0; i<62; i++ ){
        spi_write( reg_add[i], AD9102_example6_regval[i] );
    }
}

/*
 * @brief Write data to SRAM
 * @param data[] - array of data to be written to SRAM
 * @return none
 */
void update_sram( int16_t data[] )
{
    spi_write( 0x001E, 0x0004 );

    int16_t data_shifted = 0;

    uint16_t sram_add = 0x6000;

    for ( int i=0; i<4096; i++ ){
        data_shifted = data[i] << 2;
        spi_write( sram_add+i, data_shifted );
    }

    spi_write( 0x001E, 0x0010 );
}


/*
 * @brief Reset AD910x SPI registers to default values
 * @param none
 * @return none
 */
void reg_reset()
{
	int reset = 1;
    wait_us( 1000 );
	reset = 0;
}

/*
 * @brief Print register address and data in hexadecimal format
 * @param addr - SPI/SRAM register address
 * @param data - 16-bit data
 * @return none
 */
void print_data( uint16_t addr, uint16_t data )
{
	PRINTF( "0x%04X, 0x%04X\n", addr, data );
}

/*
 * @brief Start pattern generation by setting AD910x trigger pin to 0
 * @param none
 * @return none
 */
void start_pattern()
{
    int triggerb = 0;
}

/*
 * @brief Stop pattern generation by setting AD910x trigger pin to 1
 * @param none
 * @return none
 */
void stop_pattern()
{
    int triggerb = 1;
}
